<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
            content="DVDr es una herramienta web simple y gratuita para calcular y dividir gastos compartidos entre amigos, familiares o compa√±eros de viaje. Registra qui√©n pag√≥ qu√© y salda las deudas f√°cilmente.">
        <meta name="theme-color" content="#274768" />
        <link rel="manifest" href="manifest.json">
        <link rel="apple-touch-icon" href="icons/icon-192x192.png">
        <meta name="application-name" content="DVDr">
        <meta name="author" content="CrysoK">
        <!-- Open Graph / Facebook / WhatsApp -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://dvdr.vercel.app/">
        <meta property="og:title" content="DVDr - Divid√≠ gastos, no amistades">
        <meta property="og:description"
            content="Calculadora gratuita para dividir gastos compartidos en viajes y juntadas. Sin registro, simple y r√°pida.">
        <meta property="og:image" content="https://dvdr.vercel.app/og-image.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="DVDr - Calculadora de gastos compartidos">
        <meta name="twitter:description"
            content="Olv√≠date de las cuentas complicadas. Registra gastos y salda deudas f√°cilmente.">
        <meta name="twitter:image" content="https://dvdr.vercel.app/og-image.png">
        <title>DVDr - Calculadora de gastos compartidos</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
        <link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
        <link rel="shortcut icon" href="/icons/favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="DVDr" />
        <link rel="stylesheet" href="style.css">
        <script defer src="script.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    </head>

    <body x-data="app()" x-cloak>
        <div class="container">
            <header class="header">
                <h1>
                    <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"
                        aria-label="Logo DVDr">
                        <rect width="100" height="100" rx="22" fill="#274768" />
                        <circle cx="50" cy="50" r="32" stroke="#91dbc0" stroke-width="6" fill="none" />
                        <circle cx="50" cy="33" r="5" fill="#91dbc0" />
                        <rect x="32" y="47" width="36" height="6" rx="3" fill="#91dbc0" />
                        <circle cx="50" cy="67" r="5" fill="#91dbc0" />
                    </svg>
                    DVDr
                </h1>
                <p>Divid√≠ gastos, no amistades</p>
            </header>

            <div class="main-grid">
                <!-- COLUMNA IZQUIERDA: PERSONAS, DEUDAS E HISTORIAL -->
                <div class="left-column">
                    <!-- SECCI√ìN PERSONAS -->
                    <div class="card">
                        <h2 class="card-header"><span>üë•</span> 1. A√±ade a las personas</h2>
                        <form @submit.prevent="addPerson" class="add-person-form">
                            <div class="form-group">
                                <label for="person-name">Nombre:</label>
                                <input type="text" id="person-name" placeholder="Ej: Ana" x-model="newPersonName"
                                    required>
                            </div>
                            <button type="submit">A√±adir persona</button>
                        </form>
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">
                        <template x-if="people.length === 0">
                            <div class="empty-state-wrapper">
                                <p class="empty-state">A√∫n no hay personas a√±adidas.</p>
                                <button @click="loadDemoData" type="button" class="demo-btn">
                                    Cargar ejemplo
                                </button>
                            </div>
                        </template>
                        <div class="people-list-container" x-show="people.length > 0">
                            <div class="people-list">
                                <template x-for="person in people" :key="person">
                                    <div class="person-pill">
                                        <template x-if="editingPerson.oldName !== person">
                                            <span x-text="person"></span>
                                        </template>
                                        <template x-if="editingPerson.oldName === person">
                                            <input type="text" x-model="editingPerson.newName"
                                                @keydown.enter.prevent="savePersonName(person)"
                                                @keydown.escape.window="cancelEditPerson" @blur="savePersonName(person)"
                                                x-ref="personInput"
                                                x-init="$nextTick(() => { $el.focus(); $el.select(); })">
                                        </template>
                                        <button class="person-action-btn" @click="startEditPerson(person)"
                                            title="Editar nombre" x-show="editingPerson.oldName !== person">‚úèÔ∏è</button>
                                        <button @click="removePerson(person)" class="delete-person-btn"
                                            title="Eliminar persona">&times;</button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN RESUMEN DEUDAS -->
                    <div class="card">
                        <h2 class="card-header"><span>‚úÖ</span> Resumen de deudas</h2>
                        <ul class="results-list">
                            <template x-if="simplifiedDebts.length === 0">
                                <li class="empty-state">No hay deudas pendientes.</li>
                            </template>
                            <template x-for="debt in simplifiedDebts" :key="`${debt.from}-${debt.to}`">
                                <li class="debt-item">
                                    <span x-text="debt.from"></span>
                                    <span class="debt-arrow">‚ûî</span>
                                    <span x-text="debt.to"></span>
                                    <span x-text="formatAmount(debt.amount)"></span>
                                </li>
                            </template>
                        </ul>
                        <div id="share-section">
                            <button @click="copyShortSummary" class="secondary">Copiar resumen</button>
                            <button @click="copyDetailedSummary" class="secondary">Resumen detallado</button>
                            <button @click="generateShareLink" class="secondary">Crear enlace</button>
                        </div>
                    </div>

                    <!-- SECCI√ìN HISTORIAL DE DIVISIONES -->
                    <div class="card">
                        <h2 class="card-header"><span>üóÇÔ∏è</span> Historial de divisiones</h2>
                        <form @submit.prevent="saveToHistory" style="margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="history-name">Nombre de la divisi√≥n:</label>
                                <input type="text" id="history-name" x-model="newHistoryName"
                                    placeholder="Ej: Viaje a la playa" required>
                            </div>
                            <button type="submit" :disabled="people.length === 0">Guardar divisi√≥n actual</button>
                        </form>
                        <ul class="history-list">
                            <template x-if="history.length === 0">
                                <li class="empty-state">No hay divisiones guardadas.</li>
                            </template>
                            <template x-for="item in history" :key="item.id">
                                <li>
                                    <div class="history-icon" style="color: var(--secondary-color);"><span>üìÇ</span>
                                    </div>
                                    <div class="history-details">
                                        <div class="description" x-text="item.name"></div>
                                        <div class="metadata"
                                            x-text="`${formatDate(item.date)} ‚Ä¢ ${item.data.people.length} personas ‚Ä¢ ${item.data.transactions.length} transacciones`">
                                        </div>
                                    </div>
                                    <div class="history-actions">
                                        <button @click="loadFromHistory(item.id)" class="history-action-btn"
                                            title="Cargar">üì•</button>
                                        <button @click="removeFromHistory(item.id)" class="history-action-btn delete"
                                            title="Eliminar">üóëÔ∏è</button>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>

                </div>

                <!-- COLUMNA DERECHA: TRANSACCIONES E HISTORIAL -->
                <div class="right-column">
                    <!-- SECCI√ìN TRANSACCIONES -->
                    <div class="card" x-show="people.length > 1">
                        <h2 class="card-header"><span>‚úçÔ∏è</span> 2. Registra las transacciones</h2>
                        <!-- Pesta√±as -->
                        <div class="tabs">
                            <button class="tab-button" :class="{ 'active': activeTab === 'expense' }"
                                @click="activeTab = 'expense'">Gasto</button>
                            <button class="tab-button" :class="{ 'active': activeTab === 'adjustment' }"
                                @click="activeTab = 'adjustment'">Ajuste</button>
                            <button class="tab-button" :class="{ 'active': activeTab === 'transfer' }"
                                @click="activeTab = 'transfer'">Transferencia</button>
                        </div>

                        <!-- Formulario de Gasto -->
                        <form x-show="activeTab === 'expense'" @submit.prevent="addExpense">
                            <div class="form-group">
                                <label for="expense-description">Descripci√≥n:</label>
                                <input type="text" id="expense-description" x-model="expenseForm.description"
                                    placeholder="Ej: Cena, supermercado" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-amount">Monto total:</label>
                                <input type="number" id="expense-amount" x-model.number="expenseForm.amount"
                                    placeholder="50.00" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-payer">¬øQui√©n pag√≥?</label>
                                <select id="expense-payer" x-model="expenseForm.payer" required>
                                    <option value="" disabled>Selecciona una persona</option>
                                    <template x-for="person in people" :key="person">
                                        <option :value="person" x-text="person"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>¬øEntre qui√©nes se divide?</label>
                                <div class="participants-grid">
                                    <template x-for="person in people" :key="person">
                                        <div class="participant-item">
                                            <input type="checkbox" :id="'participant-' + person" :value="person"
                                                x-model="expenseForm.participants" class="visually-hidden">
                                            <label :for="'participant-' + person" x-text="person"></label>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Tipo de divisi√≥n:</label>
                                <select x-model="expenseForm.splitType">
                                    <option value="equal">Partes iguales</option>
                                    <option value="custom">Divisi√≥n personalizada</option>
                                </select>
                            </div>
                            <div id="custom-split-container" x-show="expenseForm.splitType === 'custom'">
                                <p><strong>Especifica las partes para cada participante:</strong></p>
                                <div class="custom-split-grid">
                                    <template x-for="p in expenseForm.participants" :key="p">
                                        <div class="form-group">
                                            <label x-text="p"></label>
                                            <input type="number" x-model.number="expenseForm.customSplit[p]"
                                                placeholder="1" min="0" step="0.01">
                                        </div>
                                    </template>
                                </div>
                                <small x-text="`Suma total de partes: ${customSplitTotal.toFixed(2)}`"></small>
                            </div>
                            <div class="form-actions">
                                <button type="submit"
                                    x-text="editingTransactionId ? 'Guardar cambios' : 'A√±adir gasto'"></button>
                                <button type="button" class="secondary" x-show="editingTransactionId"
                                    @click="cancelEditTransaction">Cancelar</button>
                            </div>
                        </form>

                        <!-- Formulario de Ajuste (Premio/Multa) -->
                        <form x-show="activeTab === 'adjustment'" @submit.prevent="addAdjustment">
                            <div class="form-group">
                                <label for="adjustment-description">Descripci√≥n:</label>
                                <input type="text" id="adjustment-description" x-model="adjustmentForm.description"
                                    placeholder="Ej: Premio por ganar" required>
                            </div>
                            <div class="form-group">
                                <label for="adjustment-amount">Monto del ajuste:</label>
                                <input type="number" id="adjustment-amount" x-model.number="adjustmentForm.amount"
                                    placeholder="10.00" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="adjustment-beneficiary">¬øQui√©n recibe este ajuste (beneficiario)?</label>
                                <select id="adjustment-beneficiary" x-model="adjustmentForm.beneficiary" required>
                                    <option value="" disabled>Selecciona una persona</option>
                                    <template x-for="person in people" :key="person">
                                        <option :value="person" x-text="person"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>¬øQui√©nes cubren este ajuste?</label>
                                <div class="participants-grid">
                                    <template x-for="person in people" :key="person">
                                        <div class="participant-item">
                                            <input type="checkbox" :id="'contributor-' + person" :value="person"
                                                x-model="adjustmentForm.contributors" class="visually-hidden">
                                            <label :for="'contributor-' + person" x-text="person"></label>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="warning"
                                    x-text="editingTransactionId ? 'Guardar cambios' : 'A√±adir ajuste'"></button>
                                <button type="button" class="secondary" x-show="editingTransactionId"
                                    @click="cancelEditTransaction">Cancelar</button>
                            </div>
                        </form>

                        <!-- Formulario de Transferencia -->
                        <form x-show="activeTab === 'transfer'" @submit.prevent="addTransfer">
                            <div class="form-group">
                                <label for="transfer-from">Qui√©n transfiere (de):</label>
                                <select id="transfer-from" x-model="transferForm.from" required>
                                    <option value="" disabled>Selecciona</option>
                                    <template x-for="person in people" :key="person">
                                        <option :value="person" x-text="person"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="transfer-to">Qui√©n recibe (a):</label>
                                <select id="transfer-to" x-model="transferForm.to" required>
                                    <option value="" disabled>Selecciona</option>
                                    <template x-for="person in people" :key="person">
                                        <option :value="person" x-text="person"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="transfer-amount">Monto:</label>
                                <input type="number" id="transfer-amount" x-model.number="transferForm.amount"
                                    placeholder="20.00" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit"
                                    x-text="editingTransactionId ? 'Guardar cambios' : 'A√±adir transferencia'"></button>
                                <button type="button" class="secondary" x-show="editingTransactionId"
                                    @click="cancelEditTransaction">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <!-- SECCI√ìN HISTORIAL -->
                    <div class="card">
                        <h2 class="card-header"><span>üóìÔ∏è</span> Historial de transacciones</h2>
                        <ul class="history-list">
                            <template x-if="transactions.length === 0">
                                <li class="empty-state">No hay transacciones registradas.</li>
                            </template>
                            <template x-for="tx in transactions.slice().reverse()" :key="tx.id">
                                <li>
                                    <div class="history-icon"
                                        :style="{color: tx.type === 'expense' ? 'var(--primary-color)' : (tx.type === 'adjustment' ? 'var(--warning-color)' : 'var(--success-color)')}">
                                        <span
                                            x-text="tx.type === 'expense' ? 'üõí' : (tx.type === 'adjustment' ? 'üèÜ' : 'üí∏')"></span>
                                    </div>
                                    <div class="history-details">
                                        <div class="description" x-text="tx.description"></div>
                                        <template x-if="tx.type === 'expense'">
                                            <div class="metadata"><strong x-text="formatAmount(tx.amount)"></strong>
                                                pagado por <strong x-text="tx.payer"></strong>. Dividido entre <span
                                                    x-text="tx.shares.map(s => s.person).join(', ')"></span>.</div>
                                        </template>
                                        <template x-if="tx.type === 'adjustment'">
                                            <div class="metadata"><strong x-text="formatAmount(tx.amount)"></strong> a
                                                favor de <strong x-text="tx.beneficiary"></strong>. Cubierto por <span
                                                    x-text="tx.contributors.join(', ')"></span>.</div>
                                        </template>
                                        <template x-if="tx.type === 'transfer'">
                                            <div class="metadata"><strong x-text="formatAmount(tx.amount)"></strong> de
                                                <strong x-text="tx.from"></strong> a <strong x-text="tx.to"></strong>.
                                            </div>
                                        </template>
                                    </div>
                                    <div class="history-actions">
                                        <button @click="editTransaction(tx)" class="history-action-btn"
                                            title="Editar">‚úèÔ∏è</button>
                                        <button @click="removeTransaction(tx.id)" class="history-action-btn delete"
                                            title="Eliminar">üóëÔ∏è</button>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <details>
                        <summary>Ver resumen de totales</summary>
                        <div class="details-content">
                            <h4 style="margin-top: 1.5em;">Total pagado (neto)</h4>
                            <ul class="results-list">
                                <template x-for="person in people" :key="person">
                                    <li><span x-text="person"></span><span
                                            x-text="formatAmount(totals.totalPaidNet[person] || 0)"></span></li>
                                </template>
                            </ul>
                            <h4 style="margin-top: 1.5em;">Total por pagar (lo que correspond√≠a)</h4>
                            <ul class="results-list">
                                <template x-for="person in people" :key="person">
                                    <li><span x-text="person"></span><span
                                            x-text="formatAmount(totals.totalShare[person] || 0)"></span></li>
                                </template>
                            </ul>
                        </div>
                    </details>

                    <div class="card">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button @click="loadDemoData" class="secondary">ü™Ñ Cargar datos de demostraci√≥n</button>
                            <button @click="clearCurrentDivision" class="secondary">Limpiar divisi√≥n actual</button>
                            <button @click="resetData" class="danger">Reiniciar todos los datos</button>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <p>
                    DVDr v<span x-text="version"></span> ‚Ä¢
                    <button @click="openChangelog" class="link-btn">Novedades</button>
                </p>
            </footer>
        </div>

        <!-- Notification Container -->
        <div class="notification-container">
            <template x-for="notification in notifications" :key="notification.id">
                <div class="notification" :class="'notification-' + notification.type" x-show="notification.visible"
                    x-transition:enter-start="opacity-0 translate-x-full"
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:leave="transition ease-in duration-300"
                    x-transition:leave-end="opacity-0 translate-x-full" role="alert">
                    <span x-text="notification.message"></span>
                    <button @click="removeNotification(notification.id)" title="Cerrar">&times;</button>
                </div>
            </template>
        </div>

        <!-- MODAL CHANGELOG -->
        <div class="modal-overlay" x-show="changelog.show" x-cloak x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-end="opacity-0">
            <div class="modal-box modal-wide" @click.outside="closeChangelog()"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0 scale-95">
                <div class="modal-header">
                    <h3 class="modal-title">Novedades</h3>
                    <button @click="closeChangelog" class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-content-scroll">
                    <template x-if="changelog.loading">
                        <div class="loading-state">Cargando datos de GitHub...</div>
                    </template>
                    <template x-if="changelog.error">
                        <div class="error-state">
                            <p>No se pudo cargar el historial de cambios.</p>
                            <small>Verifica tu conexi√≥n a internet.</small>
                        </div>
                    </template>
                    <template x-for="release in changelog.data" :key="release.tag">
                        <div class="release-item">
                            <div class="release-header">
                                <span class="release-tag" x-text="release.tag"></span>
                                <span class="release-date" x-text="release.date"></span>
                            </div>
                            <div class="release-body" x-html="release.body"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal-overlay" x-show="confirmation.show" x-cloak
            x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0">
            <div class="modal-box" x-show="confirmation.show" @click.outside="handleCancel()"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0 scale-95"
                role="dialog" aria-modal="true">
                <h3 class="modal-title" x-text="confirmation.title"></h3>
                <p class="modal-message" x-text="confirmation.message"></p>
                <div class="modal-actions">
                    <button @click="handleCancel()" class="secondary" x-text="confirmation.cancelText"></button>
                    <button @click="handleConfirm()" :class="confirmation.confirmClass"
                        x-text="confirmation.confirmText"></button>
                </div>
            </div>
        </div>
        <!-- Toast de Actualizaci√≥n -->
        <div class="update-toast" x-show="hasUpdate" x-cloak x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-full" x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0 translate-y-full">
            <div class="update-content">
                <span>‚ú® Nueva versi√≥n disponible</span>
                <button @click="refreshApp">Actualizar</button>
            </div>
        </div>
        <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
            data-cf-beacon='{"token": "960bfeaf2e5247d8b27653dbaed44b29"}'></script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    let refreshing = false;
                    // Escuchar cuando el SW tome el control (despu√©s de darle al bot√≥n actualizar)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (!refreshing) {
                            window.location.reload();
                            refreshing = true;
                        }
                    });
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        // 1. Si hay un SW esperando activarse (ej: recargaste la pesta√±a pero no la cerraste)
                        if (registration.waiting) {
                            window.dispatchEvent(new CustomEvent('sw-update-available', { detail: registration.waiting }));
                        }
                        // 2. Si se encuentra una actualizaci√≥n mientras usas la app
                        registration.onupdatefound = () => {
                            const newWorker = registration.installing;
                            newWorker.onstatechange = () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Avisar a Alpine.js
                                    window.dispatchEvent(new CustomEvent('sw-update-available', { detail: newWorker }));
                                }
                            };
                        };
                    });
                });
            }
        </script>
    </body>

</html>
